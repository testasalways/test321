name: Healthcheck

on:
  workflow_dispatch:

  schedule:
    - cron: '0 */2 * * *'

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Wait for test.yml or alert
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          end_time=$(($(date +%s) + 300))
          while [ $(date +%s) -lt $end_time ]; do
            runs=$(gh run list --workflow=test.yml --status=in_progress 2>/dev/null || true)
            if [ -n "$runs" ]; then
              echo "‚úÖ Test is in progress."
              exit 0
            fi
            echo "‚ö†Ô∏è No test in progress, waiting 30s..."
            sleep 30
          done

          text="üî¥ Test is stuck. Restarting..."
          echo "$text"
          gh workflow run test.yml
          
          job_url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          chat_id="${{ secrets.TELEGRAM_CHAT_ID }}"
          api_url="https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
          curl -s -X POST "$api_url" -d "chat_id=$chat_id" -d "parse_mode=HTML" -d "text=<a href=\"$job_url\">$text</a>"
